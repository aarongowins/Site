(function(f){"object"==typeof exports&&"object"==typeof module?f(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],f):f(CodeMirror)})(function(f){function p(){this.overlay=this.posFrom=this.posTo=this.query=null}function i(a){return a.state.search||(a.state.search=new p)}function g(a){return"string"==typeof a&&a==a.toLowerCase()}function h(a,c,b){return a.getSearchCursor(c,
b,g(c))}function j(a,c,b,e,d){a.openDialog?a.openDialog(c,d,{value:e}):d(prompt(b,e))}function m(a){var c=a.match(/^\/(.*)\/([a-z]*)$/);if(c)try{a=RegExp(c[1],-1==c[2].indexOf("i")?"":"i")}catch(b){}if("string"==typeof a?""==a:a.test(""))a=/x^/;return a}function k(a,c){var b=i(a);if(b.query)return n(a,c);j(a,q,"Search for:",a.getSelection(),function(e){a.operation(function(){if(e&&!b.query){b.query=m(e);a.removeOverlay(b.overlay,g(b.query));var d=b.query,f=g(b.query);"string"==typeof d?d=RegExp(d.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,
"\\$&"),f?"gi":"g"):d.global||(d=RegExp(d.source,d.ignoreCase?"gi":"g"));b.overlay={token:function(a){d.lastIndex=a.pos;var b=d.exec(a.string);if(b&&b.index==a.pos)return a.pos+=b[0].length,"searching";b?a.pos=b.index:a.skipToEnd()}};a.addOverlay(b.overlay);a.showMatchesOnScrollbar&&(b.annotate&&(b.annotate.clear(),b.annotate=null),b.annotate=a.showMatchesOnScrollbar(b.query,g(b.query)));b.posFrom=b.posTo=a.getCursor();n(a,c)}})})}function n(a,c){a.operation(function(){var b=i(a),e=h(a,b.query,c?
b.posFrom:b.posTo);if(!e.find(c)&&(e=h(a,b.query,c?f.Pos(a.lastLine()):f.Pos(a.firstLine(),0)),!e.find(c)))return;a.setSelection(e.from(),e.to());a.scrollIntoView({from:e.from(),to:e.to()});b.posFrom=e.from();b.posTo=e.to()})}function l(a){a.operation(function(){var c=i(a);c.query&&(c.query=null,a.removeOverlay(c.overlay),c.annotate&&(c.annotate.clear(),c.annotate=null))})}function o(a,c){a.getOption("readOnly")||j(a,r,"Replace:",a.getSelection(),function(b){b&&(b=m(b),j(a,s,"Replace with:","",function(e){if(c)a.operation(function(){for(var c=
h(a,b);c.findNext();)if("string"!=typeof b){var d=a.getRange(c.from(),c.to()).match(b);c.replace(e.replace(/\$(\d)/g,function(a,b){return d[b]}))}else c.replace(e)});else{l(a);var d=h(a,b,a.getCursor()),f=function(){var c=d.from(),g;if(!(g=d.findNext()))if(d=h(a,b),!(g=d.findNext())||c&&d.from().line==c.line&&d.from().ch==c.ch)return;a.setSelection(d.from(),d.to());a.scrollIntoView({from:d.from(),to:d.to()});c=[function(){var a=g;d.replace("string"==typeof b?e:e.replace(/\$(\d)/g,function(b,c){return a[c]}));
f()},f];if(a.openConfirm)a.openConfirm(t,c);else if(confirm("Replace?"))c[0]()};f()}}))})}var q='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',r='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',s='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',
t="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";f.commands.find=function(a){l(a);k(a)};f.commands.findNext=k;f.commands.findPrev=function(a){k(a,!0)};f.commands.clearSearch=l;f.commands.replace=o;f.commands.replaceAll=function(a){o(a,!0)}});