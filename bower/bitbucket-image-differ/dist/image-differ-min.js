if("undefined"==typeof bitbucket)var bitbucket={};"undefined"==typeof bitbucket.component&&(bitbucket.component={});"undefined"==typeof bitbucket.component.imageDiffer&&(bitbucket.component.imageDiffer={});"undefined"==typeof bitbucket.component.imageDiffer.toolbar&&(bitbucket.component.imageDiffer.toolbar={});
bitbucket.component.imageDiffer.toolbar.main=function(){return""+aui.toolbar2.toolbar2({content:""+aui.toolbar2.item({item:"primary",extraClasses:"image-differ-toggle",content:""+bitbucket.component.imageDiffer.toolbar.toggleButtons(null)}),extraClasses:"image-differ-toolbar"})};goog.DEBUG&&(bitbucket.component.imageDiffer.toolbar.main.soyTemplateName="bitbucket.component.imageDiffer.toolbar.main");
bitbucket.component.imageDiffer.toolbar.toggleButtons=function(){return""+aui.buttons.buttons({content:""+aui.buttons.button({extraClasses:"image-differ-two-up",isPressed:true,text:AJS.I18n.getText("imageDiffer.toolbar.button.two-up"),extraAttributes:{title:AJS.I18n.getText("imageDiffer.toolbar.button.two-up.tooltip")}})+aui.buttons.button({extraClasses:"image-differ-blend",isDisabled:true,text:AJS.I18n.getText("imageDiffer.toolbar.button.blend"),extraAttributes:{title:AJS.I18n.getText("imageDiffer.toolbar.button.blend.disabled.tooltip"),
"data-enabled-title":AJS.I18n.getText("imageDiffer.toolbar.button.blend.tooltip")}})+aui.buttons.button({extraClasses:"image-differ-split",isDisabled:true,text:AJS.I18n.getText("imageDiffer.toolbar.button.split"),extraAttributes:{title:AJS.I18n.getText("imageDiffer.toolbar.button.split.disabled.tooltip"),"data-enabled-title":AJS.I18n.getText("imageDiffer.toolbar.button.split.tooltip")}})+aui.buttons.button({extraClasses:"image-differ-pixeldiff",isDisabled:true,text:AJS.I18n.getText("imageDiffer.toolbar.button.pixeldiff"),
extraAttributes:{title:AJS.I18n.getText("imageDiffer.toolbar.button.pixeldiff.disabled.tooltip"),"data-enabled-title":AJS.I18n.getText("imageDiffer.toolbar.button.pixeldiff.tooltip")}})})};goog.DEBUG&&(bitbucket.component.imageDiffer.toolbar.toggleButtons.soyTemplateName="bitbucket.component.imageDiffer.toolbar.toggleButtons");"undefined"==typeof bitbucket&&(bitbucket={});"undefined"==typeof bitbucket.component&&(bitbucket.component={});
"undefined"==typeof bitbucket.component.imageDiffer&&(bitbucket.component.imageDiffer={});bitbucket.component.imageDiffer.imageContainer=function(){return'<div class="image-container" />'};goog.DEBUG&&(bitbucket.component.imageDiffer.imageContainer.soyTemplateName="bitbucket.component.imageDiffer.imageContainer");bitbucket.component.imageDiffer.splitContainer=function(){return'<div class="split-container" />'};goog.DEBUG&&(bitbucket.component.imageDiffer.splitContainer.soyTemplateName="bitbucket.component.imageDiffer.splitContainer");
bitbucket.component.imageDiffer.pixelDiffContainer=function(){return'<div class="pixeldiff-container" />'};goog.DEBUG&&(bitbucket.component.imageDiffer.pixelDiffContainer.soyTemplateName="bitbucket.component.imageDiffer.pixelDiffContainer");bitbucket.component.imageDiffer.pixelDiffImage=function(i){return'<div class="pixeldiff binary"><img src="'+soy.$$escapeHtml(i.imageSrc)+'" /></div>'};goog.DEBUG&&(bitbucket.component.imageDiffer.pixelDiffImage.soyTemplateName="bitbucket.component.imageDiffer.pixelDiffImage");
bitbucket.component.imageDiffer.opacitySlider=function(){return'<div class="opacity-slider-container"><input type="range" min="0" max="1" step="0.01" value="1" /></div>'};goog.DEBUG&&(bitbucket.component.imageDiffer.opacitySlider.soyTemplateName="bitbucket.component.imageDiffer.opacitySlider");bitbucket.component.imageDiffer.spinner=function(){return'<div class="spinner" />'};goog.DEBUG&&(bitbucket.component.imageDiffer.spinner.soyTemplateName="bitbucket.component.imageDiffer.spinner");
(function(i){typeof define==="function"&&define.amd?define(["exports","module","jquery","bitbucket/internal/widget","lodash","resemble"],i):typeof define==="function"&&!define.amd?define("bitbucket/internal/image-differ",["exports","module","jquery","bitbucket/internal/widget","lodash","resemble"],i):typeof exports!=="undefined"&&i(exports,module)})(function(i,B){function m(h){var a=c(h);if(a.data("natural-size"))return c.Deferred().resolve(a.data("natural-size"));if(h.naturalWidth){h={width:h.naturalWidth,
height:h.naturalHeight};a.data("natural-size",h);return c.Deferred().resolve(h)}var b=new Image,d=c.Deferred(),h=k.once(function(){var e={width:b.width,height:b.height};a.data("natural-size",e);d.resolve(e)});b.onload=h;b.src=a.attr("src");b.complete&&h();return d}function n(c,a){var b=c.data("margin_border_padding");if(b==null){b=c.outerWidth(true)-c.width();c.data("margin_border_padding",b)}return a-b}function t(c){var a=document.createElement("canvas"),b=a.getContext("2d");return m(c).then(function(d){a.height=
d.height;a.width=d.width;b.drawImage(c[0],0,0);return b.getImageData(0,0,a.width,a.height)})}var u=function a(b,d,e){var c=Object.getOwnPropertyDescriptor(b,d);if(c===void 0){b=Object.getPrototypeOf(b);return b===null?void 0:a(b,d,e)}if("value"in c&&c.writable)return c.value;d=c.get;return d===void 0?void 0:d.call(e)},v=function(a,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,
{constructor:{value:a,enumerable:false,writable:true,configurable:true}});if(b)a.__proto__=b},o,w=function(a,b){for(var d in b){var c=b[d];c.configurable=true;if(c.value)c.writable=true}Object.defineProperties(a,b)};o=function(a,b,c){b&&w(a.prototype,b);c&&w(a,c);return a};var r=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function");},c=require("jquery"),x=require("bitbucket/internal/widget"),k=require("lodash"),y=require("resemble"),g={TWO_UP:"two-up",BLEND:"blend",
SPLIT:"split",PIXEL_DIFF:"pixeldiff"},s=function(a,b){r(this,s);if(a)this.setup=a;if(b)this.destroy=b};o(s,{setup:{value:function(){}},destroy:{value:function(){}}});var p=s,j=function(a){r(this,j);u(Object.getPrototypeOf(j.prototype),"constructor",this).call(this);this._$container=c(a)};v(j,x);o(j,{init:{value:function(){var a=this,b=this._$imgs=this._$container.find("img");this._$sinceImg=b.eq(0);this._$untilImg=b.eq(1);this._$untilRevision=this._$untilImg.parent();this._$sinceRevision=this._$sinceImg.parent();
this._$revisions=this._$untilRevision.add(this._$sinceRevision);this._$untilRevisionLabel=this._$untilRevision.find("h5");this._$sinceRevisionLabel=this._$sinceRevision.find("h5");this._setupDiffModes();this.setMode(g.TWO_UP);var d=c.Deferred(),e=[g.TWO_UP],f=k.chain(g).values().difference(e).value();c.when(m(this._$sinceImg),m(this._$untilImg)).done(function(b,c){a.enabledModes=b.width===c.width&&b.height===c.height&&b.width>0?e.concat(f):e;d.resolve(a.enabledModes)}).fail(function(){d.reject()});
return d}},destroy:{value:function(){this.modes&&this._mode&&this.modes[this._mode].destroy();this._mode=null}},setMode:{value:function(a){if(this._mode!==a){this._onDiffModeChanged(a,this._mode);this._mode=a}}},_onDiffModeChanged:{value:function(a,b){this._$container.removeClass(k.values(g).join(" ")).addClass(a);b&&this.modes[b].destroy();a&&this.modes[a].setup();this.trigger("modeChanged",{newMode:a,oldMode:b})}},_setupDiffModes:{value:function(){var a=this;this.modes={};this.modes[g.TWO_UP]=new p;
this.modes[g.BLEND]=new p(function(){var b=c(bitbucket.component.imageDiffer.opacitySlider());a._$container.children(".since-revision").before(b);b.on("input change",'input[type="range"]',function(b){a._$untilImg.css("opacity",parseFloat(c(b.target).val()))})},function(){var b=a._$container.children(".opacity-slider-container");b.off("input change");b.remove();a._$untilImg.css("opacity","")});this.modes[g.SPLIT]=new p(function(){m(a._$imgs).done(function(b){a._$untilImg.wrap(bitbucket.component.imageDiffer.imageContainer());
a._$revisions.wrapAll(bitbucket.component.imageDiffer.splitContainer());a._$untilRevisionImageContainer=a._$untilImg.parent();a._$splitContainer=a._$container.find(".split-container");var d=void 0,e=function(){var c=a._$untilRevisionImageContainer,e=a._$splitContainer,q=n(a._$container,a._$container.parent().width()),e=n(e,q),e=n(a._$sinceRevision,e),q=n(a._$sinceImg,e),f=Math.min(b.width,q);a._$imgs.width(f);a._$imgs.height(Math.floor(f/b.width*b.height));c.height(a._$imgs.outerHeight(true));c=f+
(e-q);a._$revisions.width(c);a._$untilRevision.css("margin-left",-c);d=a._$sinceImg.outerWidth(true)};a._onResize=k.debounce(e,200);c(window).on("resize",a._onResize);e();if(b.width<50){a._$untilRevisionLabel.css("margin-left","-50px");a._$sinceRevisionLabel.css("margin-right","-50px")}else if(b.width<100){a._$untilRevisionLabel.css("margin-left",-b.width);a._$sinceRevisionLabel.css("margin-right",-b.width)}var f=function(b){a._$untilRevisionImageContainer.css("width",Math.min(b.pageX-b.data.offset.left,
d))};a._$splitContainer.hover(function(){a._$revisions.on("mousemove",{offset:a._$untilRevision.offset()},f)},function(){a._$revisions.off("mousemove",f)})})},function(){a._$imgs.css({width:"",height:""});a._$revisions.css("width","");a._$untilRevision.css("margin-left","");a._$untilRevisionLabel.add(a._$sinceRevisionLabel).css({marginLeft:"",marginRight:""});a._$untilImg.unwrap();a._$untilRevisionImageContainer.remove();delete a._$untilRevisionImageContainer;a._$revisions.unwrap();a._$splitContainer.remove();
delete a._$splitContainer;if(a._onResize){c(window).off("resize",a._onResize);delete a._onResize}});this.modes[g.PIXEL_DIFF]=new p(function(){a._$revisions.wrapAll(bitbucket.component.imageDiffer.pixelDiffContainer());a._$pixelDiffContainer=a._$container.find(".pixeldiff-container");if(a._$pixelDiffImg)a._$pixelDiffContainer.append(a._$pixelDiffImg);else{var b=c(bitbucket.component.imageDiffer.spinner());a._$pixelDiffContainer.append(b);b.spin("large");k.defer(function(){var d=t(a._$sinceImg),e=t(a._$untilImg);
c.when(d,e).then(function(a,b){y.outputSettings({errorColor:{red:208,green:68,blue:55},errorType:"flat",transparency:0.1});var d=c.Deferred();y(a).compareTo(b).onComplete(function(a){return d.resolve(a)});return d}).done(function(b){a._$pixelDiffImg=c(bitbucket.component.imageDiffer.pixelDiffImage({imageSrc:b.getImageDataUrl()}));a._$pixelDiffContainer.append(a._$pixelDiffImg)}).always(function(){b.remove()})})}},function(){a._$pixelDiffImg&&a._$pixelDiffImg.remove();a._$revisions.unwrap();a._$pixelDiffContainer.remove();
delete a._$pixelDiffContainer})}}});var z=j,l=function(a){r(this,l);u(Object.getPrototypeOf(l.prototype),"constructor",this).call(this);this._$toolbar=c(a);this._$toggle=this._$toolbar.find(".image-differ-toggle")};v(l,x);o(l,{init:{value:function(a){var b=this,d={};k.values(g).forEach(function(c){var e=a.indexOf(c)!==-1,f=b._$toggle.find(".image-differ-"+c);f.attr("aria-disabled",!e).prop("disabled",!e);if(e){f.attr("data-enabled-title")&&f.attr("data-disabled-title",f.attr("title"));f.attr("data-mode",
c);f.attr("title",f.attr("data-enabled-title"));d[c]=f}});if(a.indexOf(g.BLEND)!==-1){var e;e=document.createElement("input");e.setAttribute("type","range");e=e.type==="range";var f=d[g.BLEND];f.attr("aria-disabled",!e).prop("disabled",!e);e||f.attr("title",f.attr("data-disabled-title"))}var i=function(a){var c=b._mode;b._mode=a;b.trigger("modeChanged",{newMode:a,oldMode:c})},j=this._$toggle.find(".aui-button");j.on("click",function(a){a.preventDefault();a=c(a.target);if(a.attr("aria-disabled")!==
"true"&&a.attr("aria-pressed")!=="true"){var b=a.attr("data-mode");j.attr("aria-pressed","false");a.attr("aria-pressed","true");i(b)}}).tooltip({gravity:"s"});i(g.TWO_UP)}},getMode:{value:function(){return this._mode}},destroy:{value:function(){if(this._$toolbar){this._$toolbar.remove();this._$toolbar=null}this._$toggle=null}}});var A=l;B.exports={init:function(a){var a=c(a),b=new A(c(bitbucket.component.imageDiffer.toolbar.main()).prependTo(a)),d=new z(a);b.on("modeChanged",function(a){d.setMode(a.newMode)});
var e=new c.Deferred;d.init().done(function(a){b&&b.init(a);e.resolve({on:d.on.bind(d),enabledModes:a,_differ:d,_toolbar:b,destroy:function(){d.destroy();d=null;b.destroy();b=null}})});return e},Differ:z,Toolbar:A}});